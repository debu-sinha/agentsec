name: Verify Signed Tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  verify-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag ${GITHUB_REF_NAME} is not semver (vX.Y.Z)."
            exit 1
          fi

      - name: Require signed annotated tag
        run: |
          sig=$(git for-each-ref "refs/tags/${GITHUB_REF_NAME}" --format='%(contents:signature)')
          if [ -z "$sig" ]; then
            echo "Tag ${GITHUB_REF_NAME} is not a signed annotated tag."
            exit 1
          fi
