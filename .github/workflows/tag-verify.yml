name: Verify Tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  verify-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        run: |
          if ! [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag ${GITHUB_REF_NAME} is not semver (vX.Y.Z)."
            exit 1
          fi

      - name: Validate tag matches pyproject.toml version
        run: |
          version=$(python3 -c "
          import tomllib, pathlib
          data = tomllib.loads(pathlib.Path('pyproject.toml').read_text())
          print(data['project']['version'])
          ")
          expected="v${version}"
          if [ "${GITHUB_REF_NAME}" != "${expected}" ]; then
            echo "Tag ${GITHUB_REF_NAME} does not match pyproject.toml version ${expected}."
            exit 1
          fi
          echo "Tag ${GITHUB_REF_NAME} matches pyproject.toml version ${version}."
